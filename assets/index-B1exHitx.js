(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();const E="modulepreload",S=function(t){return"/Tracker-G-M-ZH/"+t},p={},O=function(e,r,o){let n=Promise.resolve();if(r&&r.length>0){let w=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),a=i?.nonce||i?.getAttribute("nonce");n=w(r.map(c=>{if(c=S(c),c in p)return;p[c]=!0;const u=c.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const l=document.createElement("link");if(l.rel=u?"stylesheet":E,u||(l.as="script"),l.crossOrigin="",l.href=c,a&&l.setAttribute("nonce",a),document.head.appendChild(l),u)return new Promise((y,b)=>{l.addEventListener("load",y),l.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(i){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i}return n.then(i=>{for(const a of i||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})};function m(t){return new Promise((e,r)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>r(t.error)})}function I(t,e){let r;const o=()=>{if(r)return r;const n=indexedDB.open(t);return n.onupgradeneeded=()=>n.result.createObjectStore(e),r=m(n),r.then(s=>{s.onclose=()=>r=void 0},()=>{}),r};return(n,s)=>o().then(i=>s(i.transaction(e,n).objectStore(e)))}let h;function v(){return h||(h=I("keyval-store","keyval")),h}function P(t,e=v()){return e("readonly",r=>m(r.get(t)))}function D(t,e,r=v()){return r("readwrite",o=>new Promise((n,s)=>{o.get(t).onsuccess=function(){try{o.put(e(this.result),t),n(m(o.transaction))}catch(i){s(i)}}}))}function g(t){const e=t.innerText||t.textContent||"";return{tag:t.tagName,text:e.slice(0,50).replace(/\s+/g," ").trim(),id:t.id||"",class:t.className||""}}function f(t){if(!t||t.tagName==="BODY")return"BODY";let e=t.tagName.toLowerCase();return t.id?e+=`#${t.id}`:t.className&&typeof t.className=="string"&&(e+=`.${t.className.split(" ").join(".")}`),t.parentElement&&t.parentElement.tagName!=="BODY"?`${f(t.parentElement)} > ${e}`:e}class T{constructor(e){this.config=e||{},this.dbKey="tracker_events_v1",this.interestThreshold=2e3,this.viewMap=new Map,this.pageId=this.config.pageId||window.location.pathname,this.targetSelectors=["article","section",".card",".content-item","h1","h2","h3","p",...this.config.traceSelectors||[]].join(", "),this.init()}init(){console.log(`⚡️ SDK 启动 | PageID: [${this.pageId}] | 监控: ${this.targetSelectors}`),this.startClickTracking(),this.startViewportTracking(),this.mountUI(),this.handleUnload()}startClickTracking(){window.addEventListener("click",e=>{if(e.target.closest("#tracker-platform-root"))return;const r=f(e.target);this.saveEvent({type:"click",selector:r,...g(e.target),timestamp:Date.now()})},!0)}startViewportTracking(){const e=r=>{r.forEach(o=>{o.isIntersecting?this.viewMap.set(o.target,Date.now()):this.settleInterest(o.target)})};this.intersectionObserver=new IntersectionObserver(e,{threshold:.5}),this.observeDomChanges()}settleInterest(e){const r=this.viewMap.get(e);if(r){const o=Date.now()-r;if(this.viewMap.delete(e),o>this.interestThreshold){const n=f(e),s=g(e);console.log(`❤️ [${this.pageId}] 兴趣停留 ${o}ms`,s),this.saveEvent({type:"interest_view",duration:o,selector:n,...s,timestamp:Date.now()})}}}handleUnload(){document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&this.viewMap.forEach((e,r)=>this.settleInterest(r))})}observeDomChanges(){const e=this.targetSelectors;document.querySelectorAll(e).forEach(o=>this.intersectionObserver.observe(o)),new MutationObserver(o=>{o.forEach(n=>{n.addedNodes.forEach(s=>{s.nodeType===1&&(s.matches&&s.matches(e)&&this.intersectionObserver.observe(s),s.querySelectorAll&&s.querySelectorAll(e).forEach(i=>this.intersectionObserver.observe(i)))})})}).observe(document.body,{childList:!0,subtree:!0})}async saveEvent(e){const r={...e,pageId:this.pageId,path:window.location.pathname};try{await D(this.dbKey,(o=[])=>[...o,r].slice(-2e3))}catch{}}async getAllData(){return await P(this.dbKey)||[]}async getEventsByPage(e){return(await this.getAllData()).filter(o=>o.pageId===e)}mountUI(){O(()=>import("./report-DEDTQbwr.js"),[]).then(e=>e.mountPlatform())}}export{T,P as g,D as u};
